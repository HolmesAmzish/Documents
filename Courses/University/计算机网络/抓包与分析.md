# 抓包与分析

## 一、对ping 抓包

### 打开Wireshark 进行监听

首先要在全程打开wireshark并选择对应网卡进行监听网络数据包，这样才能抓取发送和接收的数据包。打开wireshark，这里用的是无线网络，所以选定监听WLAN网卡的数据包。此时Wireshark就开始抓取数据包。

### 发送ping 请求

```
PS C:\Users\Holme> ping 192.168.0.190

正在 Ping 192.168.0.190 具有 32 字节的数据:
来自 192.168.0.190 的回复: 字节=32 时间=2ms TTL=64
来自 192.168.0.190 的回复: 字节=32 时间=2ms TTL=64
来自 192.168.0.190 的回复: 字节=32 时间=2ms TTL=64
来自 192.168.0.190 的回复: 字节=32 时间=2ms TTL=64

192.168.0.190 的 Ping 统计信息:
    数据包: 已发送 = 4，已接收 = 4，丢失 = 0 (0% 丢失)，
往返行程的估计时间(以毫秒为单位):
    最短 = 2ms，最长 = 2ms，平均 = 2ms
PS C:\Users\Holme>
```

在windows终端中ping目标主机，系统会自动发送四个请求并接受目标主机的回复。这里显示到发送了四个数据包并接收到了四个回复，没有丢包。同时还会看到所用时间和TTL值，表示了延迟和网络路径的长短。

### 检查Wireshark 的数据

暂停抓包，会发现此时会有在当前网卡抓取到的各种数据包，需要进行筛选。首先根据ping 的结果可以看出地址为192.168.0.190，在过滤器中筛选`ip.addr == 192.168.0.190`

![image-20241027111412401](C:\Users\Holme\AppData\Roaming\Typora\typora-user-images\image-20241027111412401.png)

可以看出八个标记的数据包，分别是四个发送与接受，可以判断应该是ping 相关的数据包。

### 数据包分析

根据Wireshark对数据包的表示，首先可以看见源地址是`192.168.0.158`，目标地址是`192.168.0.190`，协议为`ICMP`。推断ping 指令的原理是，源主机发送一个ICMP回显请求消息到目标主机，目标主机收到后回应一个ICMP回显应答消息，从而测试目标主机的可达性和响应时间。

#### 帧数据

```
Frame 21839: 74 bytes on wire (592 bits), 74 bytes captured (592 bits) on interface \Device\NPF_{42D46434-0BB6-431B-B070-8FA75E0F8ABD}, id 0
    Section number: 1
    Interface id: 0 (\Device\NPF_{42D46434-0BB6-431B-B070-8FA75E0F8ABD})
        Interface name: \Device\NPF_{42D46434-0BB6-431B-B070-8FA75E0F8ABD}
        Interface description: WLAN
    Encapsulation type: Ethernet (1)
    Arrival Time: Oct 27, 2024 11:13:06.184992000 中国标准时间
    UTC Arrival Time: Oct 27, 2024 03:13:06.184992000 UTC
    Epoch Arrival Time: 1729998786.184992000
    [Time shift for this packet: 0.000000000 seconds]
    [Time delta from previous captured frame: 0.707203000 seconds]
    [Time delta from previous displayed frame: 2.338424000 seconds]
    [Time since reference or first frame: 1345.790175000 seconds]
    Frame Number: 21839
    Frame Length: 74 bytes (592 bits)
    Capture Length: 74 bytes (592 bits)
    [Frame is marked: False]
    [Frame is ignored: False]
    [Protocols in frame: eth:ethertype:ip:icmp:data]
    [Coloring Rule Name: ICMP]
    [Coloring Rule String: icmp || icmpv6]
```

帧数据的基本信息，可以看到帧编号，长度和捕获长度；接口即为刚刚设置的WLAN无线网卡。以及其他一些信息。

#### 以太网帧

```
Ethernet II, Src: CloudNetwork_e3:8c:a5 (74:97:79:e3:8c:a5), Dst: RealtekSemic_fe:8a:f8 (00:e0:4c:fe:8a:f8)
    Destination: RealtekSemic_fe:8a:f8 (00:e0:4c:fe:8a:f8)
        Address: RealtekSemic_fe:8a:f8 (00:e0:4c:fe:8a:f8)
        .... ..0. .... .... .... .... = LG bit: Globally unique address (factory default)
        .... ...0 .... .... .... .... = IG bit: Individual address (unicast)
    Source: CloudNetwork_e3:8c:a5 (74:97:79:e3:8c:a5)
        Address: CloudNetwork_e3:8c:a5 (74:97:79:e3:8c:a5)
        .... ..0. .... .... .... .... = LG bit: Globally unique address (factory default)
        .... ...0 .... .... .... .... = IG bit: Individual address (unicast)
    Type: IPv4 (0x0800)
```

在这里的信息可以看到源MAC地址和目标MAC地址。分别是`74:97:79:e3:8c:a5`和`00:e0:4c:fe:8a:f8`，类型为IPv4。



#### IP 数据包

```
Internet Protocol Version 4, Src: 192.168.0.158, Dst: 192.168.0.190
    0100 .... = Version: 4
    .... 0101 = Header Length: 20 bytes (5)
    Differentiated Services Field: 0x00 (DSCP: CS0, ECN: Not-ECT)
        0000 00.. = Differentiated Services Codepoint: Default (0)
        .... ..00 = Explicit Congestion Notification: Not ECN-Capable Transport (0)
    Total Length: 60
    Identification: 0xb6ee (46830)
    000. .... = Flags: 0x0
        0... .... = Reserved bit: Not set
        .0.. .... = Don't fragment: Not set
        ..0. .... = More fragments: Not set
    ...0 0000 0000 0000 = Fragment Offset: 0
    Time to Live: 128
    Protocol: ICMP (1)
    Header Checksum: 0x0126 [validation disabled]
    [Header checksum status: Unverified]
    Source Address: 192.168.0.158
    Destination Address: 192.168.0.190
```

IPv4协议，并且此处已经从MAC地址转换到了IP地址，这里是发送的ping请求，因此源地址是本主机192.168.0.158，目标地址是192.168.0.190。这里可以看到协议是ICMP。



#### ICMP 数据包

```
Internet Control Message Protocol
    Type: 8 (Echo (ping) request)
    Code: 0
    Checksum: 0x4d35 [correct]
    [Checksum Status: Good]
    Identifier (BE): 1 (0x0001)
    Identifier (LE): 256 (0x0100)
    Sequence Number (BE): 38 (0x0026)
    Sequence Number (LE): 9728 (0x2600)
    [Response frame: 21840]
    Data (32 bytes)
        Data: 6162636465666768696a6b6c6d6e6f7071727374757677616263646566676869
        [Length: 32]
```

最后是ICMP数据包，可以看到此处信息的校验和，标识和和序列号。同时可以看到数据是一串十六进制的内容。根据解码后的结果可以看到内容为`abcdefghijklmnopqrstuvwxyzabcefg`。

### 封装过程

这里互联网控制消息协议ICMP中发送的

## 二、对http 抓包

### 访问网站

首先在浏览器输入对应网址，对服务器发送请求，得到html页面。

![image-20241027211604837](C:\Users\Holme\AppData\Roaming\Typora\typora-user-images\image-20241027211604837.png)

### 抓取数据包

![image-20241027212406965](C:\Users\Holme\AppData\Roaming\Typora\typora-user-images\image-20241027212406965.png)

这里可以看见本次http建立相关的数据包

```
211	6.020459	192.168.0.158	192.168.0.190	TCP	66	7392 → 80 [SYN] Seq=0 Win=64240 Len=0 MSS=1460 WS=256 SACK_PERM
212	6.020612	192.168.0.158	192.168.0.190	TCP	66	7393 → 80 [SYN] Seq=0 Win=64240 Len=0 MSS=1460 WS=256 SACK_PERM
213	6.023170	192.168.0.190	192.168.0.158	TCP	66	80 → 7392 [SYN, ACK] Seq=0 Ack=1 Win=64240 Len=0 MSS=1460 SACK_PERM WS=128
214	6.023170	192.168.0.190	192.168.0.158	TCP	66	80 → 7393 [SYN, ACK] Seq=0 Ack=1 Win=64240 Len=0 MSS=1460 SACK_PERM WS=128
215	6.023271	192.168.0.158	192.168.0.190	TCP	54	7392 → 80 [ACK] Seq=1 Ack=1 Win=131328 Len=0
216	6.023288	192.168.0.158	192.168.0.190	TCP	54	7393 → 80 [ACK] Seq=1 Ack=1 Win=131328 Len=0
217	6.026118	192.168.0.158	192.168.0.190	HTTP	503	GET / HTTP/1.1 
218	6.028067	192.168.0.190	192.168.0.158	TCP	60	80 → 7392 [ACK] Seq=1 Ack=450 Win=64128 Len=0
219	6.028067	192.168.0.190	192.168.0.158	HTTP	708	HTTP/1.1 200 OK  (text/html)
220	6.079406	192.168.0.158	192.168.0.190	TCP	54	7392 → 80 [ACK] Seq=450 Ack=655 Win=130560 Len=0
```

